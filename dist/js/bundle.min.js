"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var DateConverter=function(){function e(e){var t=e.split("/"),n=new Date(t[2],t[1]-1,t[0]);return n.toISOString().split("T")[0]}function t(e){var t=e.split("-"),n=new Date(t[0],t[1]-1,t[2]);return n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear()}function n(e){return r(e,18)}function r(e,t){var n=e.split("-")[0],r=(new Date).getFullYear();return r-n>=t}return Object.create({toDateInputFormat:e,toServerFormat:t,isOfAge:n})}(),Subject=function(e){function t(e){r.push(e)}function n(e){r.forEach(function(t){return t.update(e)})}var r=e?[].concat(_toConsumableArray(e)):[];return Object.create({addObserver:t,notify:n})},DomElement=function(e){function t(e,t){var a=t.attributes,i=t.content,o=t.value;return n(e,a),r(e,i),null!==o&&void 0!==o&&(l.value=o),e}function n(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setAttribute(n,t[n])}function r(e,t){t&&("string"==typeof t?e.appendChild(document.createTextNode(t)):Array.isArray(t)?t.forEach(function(t){e.appendChild(t)}):e.appendChild(t))}var a=e.tag,i=e.content,o=e.attributes,u=e.value,l=document.createElement(a);return t(l,{content:i,attributes:o,value:u})},HttpService=function(){function e(e){return new Promise(function(t,n){a.open("GET",i+"/"+e),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?t(JSON.parse(a.responseText)):n({error:a.status}))},a.send()})}function t(e,t){return new Promise(function(n,r){a.open("POST",i+"/"+e,!0),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(t)),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?n(JSON.parse(a.responseText)):r({error:a.status}))}})}function n(e,t){return new Promise(function(n,r){a.open("PATCH",i+"/"+e+"/"+t.id,!0),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(t)),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?n(JSON.parse(a.responseText)):r({error:a.status}))}})}function r(e,t){var n=i+"/"+e+"/"+t;return new Promise(function(e,t){a.open("DELETE",n,!0),a.onload=function(){console.log("xhr.status",a.status),4==a.readyState&&(200==a.status?e(JSON.parse(a.responseText)):t({error:a.status}))},a.send(null)})}var a=new XMLHttpRequest,i="http://localhost:3000";return Object.create({get:e,post:t,remove:r,patch:n})},FormContactsUtils=function(){function e(e){var t=e.querySelectorAll("li"),n=Object.keys(t).map(function(e){return t[e]}).map(function(e){return{id:e.querySelectorAll("input")[0].value,destroy:e.querySelectorAll("input")[1].checked,code:e.querySelectorAll("input")[2].value,number:e.querySelectorAll("input")[3].value,main_number:e.querySelectorAll("input")[4].checked}}).map(function(e){return null!==e.id&&void 0!==e.id&&"undefined"!==e.id||delete e.id,e});return n}function t(e){var t=e.querySelectorAll("li"),n=Object.keys(t).map(function(e){return t[e]}).map(function(e){return{id:e.querySelectorAll("input")[0].value,destroy:e.querySelectorAll("input")[1].checked,address:e.querySelectorAll("input")[2].value}}).map(function(e){return null!==e.id&&void 0!==e.id&&"undefined"!==e.id||delete e.id,e});return n}return{getEmailList:t,getPhonesList:e}}(),CustomerFormHelper=function(){function e(e){return{name:e.nameEl.value,birthday:DateConverter.toServerFormat(e.birthdayEl.value),driver_license:{number:e.licenseNumberEl.value,issued_at:e.licenseIssueAtEl.value},state:e.stateEl.value,city:e.cityEl.value,phones:FormContactsUtils.getPhonesList(e.phonesEl),emails:FormContactsUtils.getEmailList(e.emailsEl),parent:{name:e.parentNameEl.value,phone:{code:e.parentPhoneCodeEl.value,number:e.parentPhoneNumberEl.value}}}}function t(e){return{id:e.idEl.value,name:e.nameEl.value,birthday:DateConverter.toServerFormat(e.birthdayEl.value),driver_license:{id:licenseId.value,number:e.licenseNumberEl.value,issued_at:e.licenseIssueAtEl.value,destroy:e.licenseDestroyEl.checked},state:e.stateEl.value,city:e.cityEl.value,phones:FormContactsUtils.getPhonesList(e.phonesEl,!0),emails:FormContactsUtils.getEmailList(e.emailsEl,!0),parent:{id:e.parentIdEl.value,name:e.parentNameEl.value,destroy:!!e.parentDestroyEl&&e.parentDestroyEl.checked,phone:{id:e.parentPhoneIdEl.value,code:e.parentPhoneCodeEl.value,number:e.parentPhoneNumberEl.value}}}}function n(e,t){e.idEl.value=t.id,e.nameEl.value=t.name,e.birthdayEl.value=a(t.birthday),e.stateEl.value=t.state,e.cityEl.value=t.city||"",t.driver_license?(e.licenseIdEl.value=t.driver_license.id,e.licenseNumberEl.value=t.driver_license.number,e.licenseIssueAtEl.value=t.driver_license.issued_at,e.licenseDestroyEl.checked=!1):(e.licenseNumberEl.value="",e.licenseIssueAtEl.value="",e.licenseDestroyEl.checked=!1),e.parentNameEl.value="",e.parentPhoneCodeEl.value="",e.parentPhoneNumberEl.value="",t.parent&&(e.parentIdEl.value=t.parent.id,e.parentNameEl.value=t.parent.name,e.parentPhoneIdEl.value=t.parent.phone.id,e.parentPhoneCodeEl.value=t.parent.phone.code,e.parentPhoneNumberEl.value=t.parent.phone.number,e.parentDestroyEl&&(e.parentDestroyEl.checked=!1)),e.phonesEl.innerHTML="",e.emailsEl.innerHTML="",i(e,e.phonesEl,t.phones),o(e,e.emailsEl,t.emails)}function r(e){e.idEl.value="",e.nameEl.value="",e.birthdayEl.value="",e.stateEl.value="",e.cityEl.value="",e.licenseNumberEl.value="",e.licenseIssueAtEl.value="",e.licenseDestroyEl.checked=!1,e.parentNameEl.value="",e.parentPhoneCodeEl.value="",e.parentPhoneNumberEl.value="",e.parentIdEl.value="",e.parentNameEl.value="",e.parentPhoneIdEl.value="",e.parentPhoneCodeEl.value="",e.parentPhoneNumberEl.value="",e.parentDestroyEl&&(e.parentDestroyEl.checked=!1),e.phonesEl.innerHTML="",e.emailsEl.innerHTML="",u(e.phonesEl),l(e.emailsEl)}function a(e){return DateConverter.toDateInputFormat(e)}function i(e,t,n){e.phonesEl.innerHTML="",n.forEach(function(e){return u(t,e.id,e.code,e.number)})}function o(e,t,n){e.emailsEl.innerHTML="",n.forEach(function(e){return l(t,e.id,e.address)})}function u(e,t,n,r){e.appendChild(PhoneInputView(t,n,r))}function l(e,t,n){e.appendChild(EmailInputView(t,n))}return Object.create({resetFormBasedOn:n,cleanForm:r,formValueOnEditFormat:t,formValueOnCreateFormat:e,addEmailInput:l,addPhoneInput:u})}(),CustomerFormValidator=function(e){function t(){var e=!1;return e=!!(n()&r()&a()&i()&o()&u()&l()&c())}function n(){return e.nameEl.value?(nameValidation.hidden=!0,!0):(nameValidation.hidden=!1,!1)}function r(){return e.birthdayEl.value?(birthdayValidation.hidden=!0,!0):(birthdayValidation.hidden=!1,!1)}function a(){if(licenseValidation.hidden=!0,!e.birthdayEl.value)return!0;var t=(new Date).getFullYear()-new Date(e.birthdayEl.value).getFullYear();return t<18||(!(!e.licenseNumberEl.value||!e.licenseIssueAtEl.value)||(licenseValidation.hidden=!1,!1))}function i(){return e.stateEl.value?(stateValidation.hidden=!0,!0):(stateValidation.hidden=!1,!1)}function o(){if(cityValidation.hidden=!0,!e.stateEl.value||!e.licenseNumberEl.value)return!0;var t=+(""+e.licenseNumberEl.value)[0],n="rn"===e.stateEl.value.toLowerCase();return!(!e.cityEl.value&&n&&6===t)||(cityValidation.hidden=!1,!1)}function u(){var t=FormContactsUtils.getPhonesList(e.phonesEl).filter(function(e){return!e.destroy});return maxPhoneValidation.hidden=!0,minPhoneValidation.hidden=!0,phoneValidation.hidden=!0,t.length<1?(minPhoneValidation.hidden=!1,!1):t.length>4?(maxPhoneValidation.hidden=!1,!1):!t.find(function(e){return!e.code||!e.number})||(phoneValidation.hidden=!1,!1)}function l(){var t=FormContactsUtils.getEmailList(e.emailsEl).filter(function(e){return!e.destroy&&e.address});return minEmailValidation.hidden=!0,maxEmailValidation.hidden=!0,t.length<1?(minEmailValidation.hidden=!1,!1):!(t.length>3)||(maxEmailValidation.hidden=!1,!1)}function c(){var t=!1,n=!1;return parentNameValidation.hidden=!0,parentPhoneValidation.hidden=!0,!(e.birthdayEl.value&&!DateConverter.isOfAge(e.birthdayEl.value))||(e.parentNameEl.value?parentNameValidation.hidden=!0:(parentNameValidation.hidden=!1,t=!0),e.parentPhoneCodeEl.value&&e.parentPhoneNumberEl.value?parentPhoneValidation.hidden=!0:(parentPhoneValidation.hidden=!1,n=!0),!t&&!n)}return Object.create({validateForm:t})},Form=function(e){function t(e){return document.querySelector(e)}return Object.create({form:document.querySelector(e),idEl:t("#id"),nameEl:t("#name"),birthdayEl:t("#birthday"),licenseIdEl:t("#licenseId"),licenseNumberEl:t("#licenseDate"),licenseIssueAtEl:t("#licenseIssueAt"),licenseDestroyEl:t("#licenseDestroy"),stateEl:t("#state"),cityEl:t("#city"),phonesEl:t("#phones"),emailsEl:t("#emails"),parentIdEl:t("#parentId"),parentNameEl:t("#parentName"),parentPhoneIdEl:t("#parentPhoneId"),parentPhoneCodeEl:t("#parentPhoneCode"),parentPhoneNumberEl:t("#parentPhoneNumber"),parentDestroyEl:t("#parentDestroy"),addMorePhonesBtn:t("#addMorePhonesBtn"),addMoreEmailBtn:t("#addMoreEmailBtn"),nameValidation:t("#nameValidation"),birthdayValidation:t("#birthdayValidation"),licenseValidation:t("#licenseValidation"),stateValidation:t("#stateValidation"),cityValidation:t("#cityValidation"),minPhoneValidation:t("#minPhoneValidation"),maxPhoneValidation:t("#maxPhoneValidation"),minEmailValidation:t("#minEmailValidation"),maxEmailValidation:t("#maxEmailValidation"),parentNameValidation:t("#parentNameValidation"),parentPhoneValidation:t("#parentPhoneValidation"),phoneValidation:t("#phoneValidation")})},CustumerHeader=function(e){function t(e){return DomElement({tag:"i",attributes:{"class":e}})}function n(e){if(e.driver_license){var n=DomElement({tag:"p",content:[t("icon-address-card-o customer__licence-icon"),document.createTextNode(e.driver_license.number)],attributes:{"class":"customer__title",title:"licence"}}),r=DomElement({tag:"p",content:[t("icon-calendar-empty customer__licence-icon"),document.createTextNode(e.driver_license.issued_at)],attributes:{"class":"customer__title",title:"licence"}});return DomElement({tag:"div",content:[n,r],attributes:{"class":"customer__licence"}})}return DomElement({tag:"div",content:"",attributes:{"class":"customer__title"}})}function r(e){return DomElement({tag:"h3",content:e.name,attributes:{"class":"customer__title"}})}function a(e){return DomElement({tag:"header",content:[r(e),n(e)],attributes:{"class":"customer__header"}})}return a(e)},CustumerContacts=function(e){function t(e,t){return document.createTextNode((e?e:"cidade não informada")+", "+t)}function n(e){if(!e||!e.length)return"Nenhum email cadastrado";var t=e.find(function(e){return e.main})||e[0];return t.address}function r(e){if(!e||!e.length)return"Nenhum telefone cadastrado";var t=e.find(function(e){return e.main})||e[0];return"("+t.code+")-"+t.number}function a(e){return DomElement({tag:"i",attributes:{"class":e}})}function i(e){return DomElement({tag:"p",content:[a("icon-phone"),document.createTextNode(r(e))],attributes:{"class":"customer__contact-phone"}})}function o(e){return DomElement({tag:"p",content:[a("icon-mail"),document.createTextNode(n(e))],attributes:{"class":"customer__contact-email"}})}function u(e){return DomElement({tag:"header",content:[i(e.phones),o(e.emails)],attributes:{"class":"customer__contact-header"}})}function l(e){return DomElement({tag:"p",content:[a("icon-location"),t(e.city,e.state)],attributes:{"class":"customer__contact-location"}})}function c(e){return DomElement({tag:"div",content:[u(e),l(e)],attributes:{"class":"customer__contact"}})}return c(e)},CustumerActions=function(e){function t(e){var t=DomElement({tag:"button",attributes:{"class":"btn btn--round btn--icon btn--edit icon-pencil",type:"button",name:"edit",value:e}}),n=DomElement({tag:"button",attributes:{"class":"btn btn--round btn--icon btn--danger icon-trash",type:"button",name:"delete",value:e}});return DomElement({tag:"div",attributes:{"class":"customer__actions"},content:[t,n]})}return t(e)},EmailInputView=function(e,t){function n(){var n=DomElement({tag:"input",value:e,attributes:{hidden:!0}}),r=DomElement({tag:"input",attributes:{type:"checkbox","class":"emails__item-remove"}}),a=DomElement({tag:"input",value:t,attributes:{type:"email","class":"input"}}),i=DomElement({tag:"li",content:[n,r,a],attributes:{"class":"emails__item"}});return i}return n()},PhoneInputView=function(e,t,n){function r(){var r=DomElement({tag:"input",attributes:{type:"checkbox","class":"phones__remove-check"}}),a=DomElement({tag:"input",value:e,attributes:{hidden:!0}}),i=DomElement({tag:"input",value:t,attributes:{"class":"input phone__code",placeholder:"88"}}),o=DomElement({tag:"input",value:n,attributes:{"class":"input phone__number",placeholder:"8888-8888"}}),u=DomElement({tag:"input",attributes:{"class":"phone__radio",type:"radio",name:"mainFone"}}),l=DomElement({tag:"span",content:"Principal"}),c=DomElement({tag:"label",content:[u,l],attributes:{"class":"phone__main-phone"}}),s=DomElement({tag:"div",content:[i,o,c],attributes:{"class":"phone"}}),d=DomElement({tag:"li",content:[a,r,s],attributes:{"class":"phones__item"}});return d}return r()},ObserverView=function(e){function t(e){var t=this.domElement.firstChild;t?this.domElement.replaceChild(this.template(e),t):this.domElement.appendChild(this.template(e))}function n(e,t){throw new Error("abs method, created as a Template designe to be iherited")}return domElement=document.querySelector(e),Object.create({domElement:domElement,update:t,template:n})},CustomersListView=function(e){function t(e){if(Array.isArray(e)){var t=e.map(function(e){var t=DomElement({tag:"div",content:[CustumerHeader(e),CustumerContacts(e)],attributes:{"class":"customer__info"}}),n=DomElement({tag:"li",attributes:{id:e.id,"class":"customer"},content:[t,CustumerActions(e.id)]});return n});return t}}function n(e,n){if(e.error)return"<p>Não foi possível recuperar os Clientes, Tente Mais tarde</p>";if(0===e.length)return"<p>Nenhum Cliente Cadastrado</p>";var r=DomElement({tag:"ul",attributes:{"class":"customers"},content:t(e)});return r}return Object.assign(ObserverView(e),{template:n})},RegisterFeedback=function(e){function t(e){return document.createTextNode(e)}return Object.assign(ObserverView(e),{template:t})},CustomerHttpService=function(){function e(e){if(!e)throw new Error("No custumer informed");return o.post(i,e).then(function(e){return console.log("res",e),e})["catch"](function(e){return e})}function t(){return o.get(i).then(function(e){return e})["catch"](function(e){return e})}function n(e){if(!e)throw new Error("No custumer id informed");return o.get(i+"/"+e).then(function(e){return e})["catch"](function(e){return e})}function r(e){if(!e)throw new Error("No custumer id informed");return o.patch(i,e).then(function(e){return e})["catch"](function(e){return e})}function a(e){if(!e)throw new Error("No custumer id informed");return o.remove(i,e).then(function(e){return e})["catch"](function(e){return e})}var i="customers",o=HttpService();return Object.create({getAll:t,getById:n,save:e,update:r,remove:a})},FormController=function(e){function t(){CustomerFormHelper.addPhoneInput(o.phonesEl),CustomerFormHelper.addEmailInput(o.emailsEl),o.addMorePhonesBtn.addEventListener("click",function(){return CustomerFormHelper.addPhoneInput(o.phonesEl)}),o.addMoreEmailBtn.addEventListener("click",function(){return CustomerFormHelper.addEmailInput(o.emailsEl)})}function n(e){o.form.addEventListener("submit",function(t){t.preventDefault(),a(o)&&e(r())})}function r(){return o.idEl.value?CustomerFormHelper.formValueOnEditFormat(o):CustomerFormHelper.formValueOnCreateFormat(o)}function a(e){return CustomerFormValidator(e).validateForm()}function i(e){e?CustomerFormHelper.resetFormBasedOn(o,e):CustomerFormHelper.cleanForm(o)}if(!e)throw new Error("Inform the Form View Selector. id, class...");var o=Form(e);return t(),Object.create({getFormValue:r,reset:i,onSubmit:n})},CustomerController=function(){function e(e){u.notify(e)}function t(e){l.notify(e)}function n(){return o.getAll().then(function(t){c=[].concat(_toConsumableArray(t)),e(t)})["catch"](function(t){return e(t)})}function r(r){return r.id?o.update(r).then(function(){return n()}).then(function(){return t("Usuário editado com sucesso")})["catch"](function(t){return e(t)}):o.save(r).then(function(){return n()}).then(function(){return t("Usuário criado com sucesso!!!!!")})["catch"](function(t){return e(t)})}function a(t){return o.remove(t).then(function(){return n()})["catch"](function(t){return e(t)})}function i(e){return c.find(function(t){return+t.id===+e})}var o=CustomerHttpService(),u=Subject(),l=Subject();u.addObserver(CustomersListView("#customers-view")),l.addObserver(RegisterFeedback("#customer-crud-msg-view"));var c=[];return Object.create({customerApi:o,getAllCustomers:n,save:r,remove:a,getEditingCustomer:i})},AppViewController=function(e,t){function n(e){e()}function r(t){return e.onSubmit(function(n){t(n).then(function(){return e.reset()})})}function a(e){return t.addEventListener("click",function(t){if("button"===t.target.type&&"delete"===t.target.name){var n=confirm("Tem certeza que deseja excluir o usuário?");n&&e(t.target.value)}})}function i(n){return t.addEventListener("click",function(t){if("button"===t.target.type&&"edit"===t.target.name){var r=n(t.target.value);e.reset(r)}})}return Object.create({onInit:n,onSubmit:r,onDelete:a,onSendToEdit:i})};!function(){var e=CustomerController(),t=AppViewController(FormController("#form-view"),document.querySelector("#customers-view"));t.onInit(e.getAllCustomers),t.onSubmit(e.save),t.onDelete(e.remove),t.onSendToEdit(e.getEditingCustomer)}();